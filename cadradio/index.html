<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#070a0f" />
  <title>HOSCAD RADIO</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="screen login-screen">
  <div class="login-card">
    <h1 class="login-title">HOSCAD RADIO</h1>
    <div class="login-sub">4-CHANNEL PTT RADIO</div>
    <div class="login-field">
      <label for="callsignInput">USERNAME</label>
      <input type="text" id="callsignInput" placeholder="ENTER UNIT NUMBER OR CAD STATION" maxlength="20" autocomplete="off" />
    </div>
    <div class="login-field">
      <label for="passwordInput">PASSWORD</label>
      <input type="password" id="passwordInput" placeholder="PASSWORD" maxlength="20" />
    </div>
    <label class="login-remember">
      <input type="checkbox" id="rememberCheck" />
      <span>REMEMBER USERNAME</span>
    </label>
    <button class="btn-connect" id="connectBtn" onclick="doLogin()">CONNECT</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- RADIO SCREEN -->
<div id="radioScreen" class="screen radio-screen" style="display:none;">
  <header class="radio-header">
    <div class="radio-brand">HOSCAD RADIO</div>
    <div class="radio-user" id="radioUser">—</div>
    <div class="radio-conn">
      <span class="conn-led" id="connLed"></span>
      <span id="connText">CONNECTING</span>
    </div>
    <button class="btn-logout" onclick="doLogout()">LOGOUT</button>
  </header>

  <main class="radio-main">
    <div class="channel-grid">
      <div class="channel-card" data-ch="main">
        <div class="ch-label">CH1</div>
        <button class="ptt-btn" data-ch="main">
          <span class="ptt-icon">PTT</span>
          <span class="ch-led" id="rxLed-main"></span>
        </button>
        <label class="rx-toggle">
          <input type="checkbox" checked data-rx-ch="main" />
          <span>RX</span>
        </label>
      </div>

      <div class="channel-card" data-ch="channel2">
        <div class="ch-label">CH2</div>
        <button class="ptt-btn" data-ch="channel2">
          <span class="ptt-icon">PTT</span>
          <span class="ch-led" id="rxLed-channel2"></span>
        </button>
        <label class="rx-toggle">
          <input type="checkbox" data-rx-ch="channel2" />
          <span>RX</span>
        </label>
      </div>

      <div class="channel-card" data-ch="channel3">
        <div class="ch-label">CH3</div>
        <button class="ptt-btn" data-ch="channel3">
          <span class="ptt-icon">PTT</span>
          <span class="ch-led" id="rxLed-channel3"></span>
        </button>
        <label class="rx-toggle">
          <input type="checkbox" data-rx-ch="channel3" />
          <span>RX</span>
        </label>
      </div>

      <div class="channel-card" data-ch="channel4">
        <div class="ch-label">CH4</div>
        <button class="ptt-btn" data-ch="channel4">
          <span class="ptt-icon">PTT</span>
          <span class="ch-led" id="rxLed-channel4"></span>
        </button>
        <label class="rx-toggle">
          <input type="checkbox" data-rx-ch="channel4" />
          <span>RX</span>
        </label>
      </div>
    </div>

    <div class="status-bar">
      <span id="radioTxStatus" class="radio-tx-text">STANDBY</span>
      <div class="radio-meter">
        <div class="radio-meter-fill" id="radioMeterFill"></div>
      </div>
    </div>

    <div class="vol-bar">
      <span class="vol-label">VOL</span>
      <input type="range" id="radioVolume" min="0" max="100" value="80" />
    </div>
  </main>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>

<!-- Radio Module -->
<script src="radio.js"></script>

<!-- App Logic -->
<script>
  const SESSION_KEY = 'cadradio_session';
  const SESSION_VERSION = 1;

  // Register service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(() => {});
  }

  // Restore remembered callsign
  const saved = localStorage.getItem('cadradio_username');
  if (saved) {
    document.getElementById('callsignInput').value = saved;
    document.getElementById('rememberCheck').checked = true;
  }

  // Enter key submits login
  document.getElementById('callsignInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') document.getElementById('passwordInput').focus();
  });
  document.getElementById('passwordInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') doLogin();
  });

  // Switch to radio screen and bind connection status
  function showRadioScreen(callsign) {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('radioScreen').style.display = 'flex';
    document.getElementById('radioUser').textContent = callsign.toUpperCase();

    const connRef = CADRadio.firebaseDb.ref('.info/connected');
    connRef.on('value', snap => {
      const led = document.getElementById('connLed');
      const txt = document.getElementById('connText');
      if (snap.val()) {
        led.classList.add('online');
        led.classList.remove('offline');
        txt.textContent = 'CONNECTED';
      } else {
        led.classList.remove('online');
        led.classList.add('offline');
        txt.textContent = 'DISCONNECTED';
      }
    });

    // No-op for standalone — we handle our own UI
    CADRadio._showBar = function() {};
  }

  async function doLogin() {
    const cs = document.getElementById('callsignInput').value.trim();
    const pw = document.getElementById('passwordInput').value.trim();
    const err = document.getElementById('loginError');
    err.textContent = '';

    if (!cs || cs.length < 2) { err.textContent = 'ENTER USERNAME (2+ CHARS)'; return; }
    if (!pw) { err.textContent = 'ENTER PASSWORD'; return; }

    document.getElementById('connectBtn').disabled = true;
    document.getElementById('connectBtn').textContent = 'CONNECTING...';

    CADRadio.init();
    const ok = await CADRadio.login(cs, pw);

    if (!ok) {
      err.textContent = 'INVALID PASSWORD OR CONNECTION FAILED';
      document.getElementById('connectBtn').disabled = false;
      document.getElementById('connectBtn').textContent = 'CONNECT';
      return;
    }

    // Remember callsign
    if (document.getElementById('rememberCheck').checked) {
      localStorage.setItem('cadradio_username', cs);
    } else {
      localStorage.removeItem('cadradio_username');
    }

    // Save session for auto-reconnect
    localStorage.setItem(SESSION_KEY, JSON.stringify({
      callsign: cs,
      roomPassword: pw,
      version: SESSION_VERSION
    }));

    showRadioScreen(cs);
  }

  async function doLogout() {
    localStorage.removeItem(SESSION_KEY);
    await CADRadio.cleanup();
    document.getElementById('radioScreen').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('passwordInput').value = '';
    document.getElementById('connectBtn').disabled = false;
    document.getElementById('connectBtn').textContent = 'CONNECT';
    document.getElementById('loginError').textContent = '';
  }

  // Auto-reconnect from stored session
  async function tryAutoReconnect() {
    let session;
    try {
      const raw = localStorage.getItem(SESSION_KEY);
      if (!raw) return false;
      session = JSON.parse(raw);
    } catch (e) {
      return false;
    }

    if (!session || session.version !== SESSION_VERSION || !session.callsign || !session.roomPassword) {
      localStorage.removeItem(SESSION_KEY);
      return false;
    }

    const err = document.getElementById('loginError');
    err.textContent = 'RECONNECTING...';
    err.style.color = '#7fffb2';

    try {
      CADRadio.init();
      const ok = await CADRadio.login(session.callsign, session.roomPassword);
      if (!ok) {
        localStorage.removeItem(SESSION_KEY);
        err.textContent = '';
        err.style.color = '';
        return false;
      }
      showRadioScreen(session.callsign);
      console.log('[CADRadio] Auto-reconnect successful');
      return true;
    } catch (e) {
      console.error('[CADRadio] Auto-reconnect failed:', e);
      localStorage.removeItem(SESSION_KEY);
      err.textContent = '';
      err.style.color = '';
      return false;
    }
  }

  // Try auto-reconnect on page load
  tryAutoReconnect();

  window.addEventListener('beforeunload', () => {
    if (CADRadio._ready) CADRadio.cleanup();
  });
</script>
</body>
</html>
