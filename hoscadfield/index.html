<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#070a0f" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="HOSCADField" />
  <title>HOSCAD FIELD</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-cadradio.svg" type="image/svg+xml" />
  <link rel="icon" href="download.png" type="image/png" />
  <link rel="apple-touch-icon" href="download.png" />
  <style>
    :root {
      --bg: #070a0f;
      --panel: #0c111a;
      --panel2: #0a0f17;
      --line: #1f2b3d;
      --text: #d9e3f2;
      --muted: #8fa1b8;
      --hi: #ffffff;
      --blue: #2f6cff;
      --yellow: #ffd66b;
      --red: #ff6b6b;
      --green: #7fffb2;
      --purple: #c084fc;
      --font-mono: Consolas, Menlo, Monaco, "Courier New", monospace;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-mono);
      text-transform: uppercase;
      font-size: 13px;
      letter-spacing: 0.3px;
      overflow: hidden;
    }

    input, select, button {
      text-transform: uppercase;
      font-family: inherit;
      letter-spacing: 0.3px;
      background: var(--panel);
      color: var(--text);
      border: 2px solid var(--line);
      padding: 10px 12px;
      font-size: 13px;
      outline: none;
    }

    button { cursor: pointer; }
    button:hover { filter: brightness(1.08); }
    input::placeholder { color: #657892; }

    .app {
      display: flex;
      flex-direction: column;
      height: 100%;
      max-width: 600px;
      margin: 0 auto;
    }

    /* Header */
    .header {
      padding: 10px 16px;
      background: var(--panel2);
      border-bottom: 2px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .brand {
      font-weight: 900;
      color: var(--hi);
      font-size: 14px;
    }

    .callsign-label {
      color: var(--green);
      font-weight: 900;
      font-size: 12px;
    }

    .cad-unit-status {
      padding: 3px 8px;
      font-weight: 900;
      font-size: 11px;
      border: 2px solid var(--line);
      min-width: 32px;
      text-align: center;
    }

    .cad-status-AV  { background: rgba(127,255,178,0.2); color: #7fffb2; border-color: #214434; }
    .cad-status-DE  { background: rgba(255,214,107,0.2); color: #ffd66b; border-color: #6a5220; }
    .cad-status-OS  { background: rgba(255,107,107,0.2); color: #ff6b6b; border-color: #5b2727; }
    .cad-status-T   { background: rgba(192,132,252,0.2); color: #c084fc; border-color: #4a2d78; }
    .cad-status-D   { background: rgba(47,108,255,0.2);  color: #6ba3ff; border-color: #1f4488; }
    .cad-status-OOS { background: rgba(100,100,100,0.2); color: #999;    border-color: #444; }
    .cad-status-BRK { background: rgba(100,100,100,0.2); color: #bbb;    border-color: #555; }
    .cad-status-UV  { background: rgba(100,100,100,0.2); color: #999;    border-color: #444; }

    .offline-indicator {
      padding: 3px 8px;
      font-weight: 900;
      font-size: 11px;
      background: rgba(255,107,107,0.2);
      color: var(--red);
      border: 2px solid #5b2727;
      display: none;
    }

    .btn-logout {
      background: #2a1212;
      border-color: #5b2727;
      color: var(--red);
      padding: 8px 14px;
      font-size: 12px;
      font-weight: 900;
      min-height: 48px;
    }

    .btn-refresh {
      background: #0a1628;
      border-color: #1a3a5c;
      color: #5ba3e6;
      padding: 8px 14px;
      font-size: 12px;
      font-weight: 900;
      min-height: 48px;
    }

    .btn-night {
      background: #1a1a2e;
      border-color: #333;
      color: var(--muted);
      padding: 8px 10px;
      font-size: 10px;
      font-weight: 900;
      min-height: 48px;
    }

    /* Login Screen */
    .login-screen {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .login-card {
      background: var(--panel2);
      border: 2px solid var(--line);
      padding: 20px;
      width: 100%;
      max-width: 360px;
    }

    .login-card h2 {
      color: var(--hi);
      font-size: 16px;
      margin-bottom: 12px;
    }

    .login-card .field {
      margin-bottom: 10px;
    }

    .login-card .field-label {
      font-size: 10px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .login-card input {
      width: 100%;
      min-height: 48px;
      font-size: 14px;
    }

    .login-card .btn-login {
      background: #0f2518;
      border-color: #214434;
      width: 100%;
      font-weight: 900;
      min-height: 52px;
      font-size: 14px;
    }

    .login-err {
      color: var(--red);
      font-size: 11px;
      margin-top: 8px;
      min-height: 16px;
    }

    .btn-install {
      background: #0a1628;
      border: 1px solid #1a3a5c;
      color: #5ba3e6;
      width: 100%;
      padding: 10px;
      font-family: inherit;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: none;
    }
    .btn-install:active {
      background: #122040;
    }

    /* Field Panel */
    .field-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .field-panel.hidden { display: none; }

    /* Alert/Note Banners */
    .field-banner {
      padding: 10px 16px;
      font-weight: 900;
      font-size: 13px;
      display: none;
      line-height: 1.3;
    }

    .field-banner.alert {
      background: rgba(255,107,107,0.2);
      color: #ffb0b0;
      border-bottom: 2px solid #5b2727;
    }

    .field-banner.note {
      background: rgba(255,214,107,0.15);
      color: var(--yellow);
      border-bottom: 2px solid #6a5220;
    }

    /* Active Call Card */
    .call-card {
      padding: 12px 16px;
      background: rgba(47, 108, 255, 0.08);
      border-bottom: 2px solid var(--line);
      display: none;
    }

    .call-card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }

    .call-card-inc {
      font-weight: 900;
      color: var(--yellow);
      font-size: 13px;
    }

    .call-card-nature {
      font-weight: 900;
      color: var(--hi);
      font-size: 13px;
    }

    .call-card-address {
      font-weight: 900;
      color: var(--hi);
      font-size: 18px;
      line-height: 1.2;
      margin-bottom: 4px;
    }

    .call-card-detail {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }

    .call-card-detail .label {
      color: #657892;
      font-size: 10px;
    }

    .call-card-note {
      margin-top: 4px;
      color: var(--yellow);
      font-weight: 900;
      font-size: 12px;
    }

    .call-card-units {
      margin-top: 4px;
      color: var(--green);
      font-size: 11px;
    }

    /* Field Status Buttons */
    .field-status-buttons {
      display: flex;
      gap: 4px;
      padding: 8px 16px;
      border-bottom: 1px solid var(--line);
      flex-wrap: wrap;
    }

    .field-status-btn {
      flex: 1;
      padding: 14px 4px;
      font-weight: 900;
      font-size: 13px;
      font-family: var(--font-mono);
      text-transform: uppercase;
      cursor: pointer;
      border: 2px solid var(--line);
      text-align: center;
      min-width: 0;
      min-height: 48px;
    }

    .field-status-de  { background: rgba(255,214,107,0.15); color: #ffd66b; border-color: #6a5220; }
    .field-status-os  { background: rgba(255,107,107,0.15); color: #ff6b6b; border-color: #5b2727; }
    .field-status-t   { background: rgba(192,132,252,0.15); color: #c084fc; border-color: #4a2d78; }
    .field-status-av  { background: rgba(127,255,178,0.15); color: #7fffb2; border-color: #214434; }
    .field-status-oos { background: rgba(100,100,100,0.15); color: #999;    border-color: #444; }
    .field-status-brk { background: rgba(100,100,100,0.15); color: #bbb;    border-color: #555; }

    .field-status-btn:active { filter: brightness(1.3); }
    .field-status-btn.current { box-shadow: 0 0 0 2px var(--hi) inset; }

    /* Status flash feedback */
    .field-status-flash {
      padding: 6px 16px;
      background: rgba(127, 255, 178, 0.12);
      color: var(--green);
      font-weight: 900;
      font-size: 11px;
      text-align: center;
      border-bottom: 1px solid var(--line);
    }

    /* Command Bar Area */
    .cmd-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border-top: 1px solid var(--line);
    }

    .cmd-feed {
      flex: 1;
      overflow-y: auto;
      padding: 8px 16px;
      font-size: 11px;
      background: var(--bg);
    }

    .cmd-feed-line {
      margin-bottom: 4px;
      line-height: 1.4;
    }

    .cmd-feed-line .cmd-ts {
      color: #555;
      font-size: 10px;
    }

    .cmd-feed-line .cmd-from {
      color: var(--blue);
      font-weight: 900;
    }

    .cmd-feed-line .cmd-urgent {
      color: var(--red);
      font-weight: 900;
    }

    .cmd-feed-line .cmd-sys {
      color: var(--yellow);
      font-weight: 700;
    }

    .cmd-feed-line .cmd-err {
      color: var(--red);
      font-weight: 700;
    }

    .cmd-feed-line .cmd-status-change {
      color: var(--green);
      font-weight: 900;
    }

    .cmd-input-row {
      display: flex;
      gap: 6px;
      padding: 6px 16px;
      background: var(--panel2);
      border-top: 1px solid var(--line);
    }

    .cmd-input-row input {
      flex: 1;
      padding: 10px 10px;
      font-size: 13px;
      min-height: 48px;
    }

    .cmd-input-row button {
      padding: 10px 16px;
      background: #0f2518;
      border-color: #214434;
      font-weight: 900;
      font-size: 12px;
      min-height: 48px;
    }

    .cmd-quick-row {
      display: flex;
      gap: 4px;
      padding: 6px 16px 8px;
      background: var(--panel2);
      flex-wrap: wrap;
    }

    .cmd-quick-btn {
      padding: 10px 12px;
      font-size: 12px;
      font-weight: 900;
      font-family: var(--font-mono);
      text-transform: uppercase;
      background: var(--panel);
      border: 1px solid var(--line);
      color: var(--muted);
      cursor: pointer;
      min-height: 48px;
    }

    .cmd-quick-btn:hover {
      background: var(--line);
      color: var(--hi);
    }

    /* Confirm Dialog */
    .confirm-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.80);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 20px;
    }

    .confirm-overlay.active {
      display: flex;
    }

    .confirm-box {
      background: var(--panel2);
      border: 2px solid var(--line);
      padding: 20px;
      max-width: 400px;
      width: 100%;
    }

    .confirm-title {
      font-size: 14px;
      font-weight: 900;
      color: var(--hi);
      margin-bottom: 12px;
    }

    .confirm-message {
      color: var(--text);
      margin-bottom: 16px;
      line-height: 1.4;
      font-size: 12px;
    }

    .confirm-buttons {
      display: flex;
      gap: 10px;
    }

    .confirm-buttons button {
      flex: 1;
      min-height: 52px;
      font-size: 14px;
      font-weight: 900;
    }

    .btn-confirm-yes {
      background: #0f2518;
      border-color: #214434;
      color: var(--green);
    }

    .btn-confirm-no {
      background: #2a1212;
      border-color: #5b2727;
      color: var(--red);
    }

    /* Night mode */
    body.night-mode .field-panel,
    body.night-mode .header {
      filter: brightness(0.65) saturate(0.8);
    }

    /* Mobile sizing */
    @media (max-width: 600px) {
      .field-status-btn {
        padding: 16px 4px;
        font-size: 14px;
      }
      .cmd-quick-btn {
        padding: 12px 14px;
        font-size: 13px;
      }
      .call-card-address {
        font-size: 16px;
      }
    }

    @media (max-width: 400px) {
      .field-status-buttons {
        flex-wrap: wrap;
      }
      .field-status-btn {
        flex: 1 1 30%;
      }
    }
  </style>
</head>
<body>

<div class="app">
  <!-- Login Screen -->
  <div id="loginScreen" class="login-screen">
    <div class="login-card">
      <h2>HOSCAD FIELD</h2>
      <div class="field">
        <div class="field-label">CALLSIGN</div>
        <input id="loginCallsign" type="text" placeholder="ENTER CALLSIGN (E.G. EMS12, CC1)" autocomplete="off" />
      </div>
      <div class="field">
        <div class="field-label">UNIT INFO (OPTIONAL)</div>
        <input id="loginUnitInfo" type="text" placeholder="E.G. 2 CREW / MEDIC 12 / ALS" autocomplete="off" />
      </div>
      <div class="field">
        <button class="btn-login" id="btnLogin">CONNECT</button>
      </div>
      <div class="login-err" id="loginErr"></div>
      <button class="btn-install" id="btnInstall">INSTALL APP</button>
    </div>
  </div>

  <!-- Field Panel (hidden until login) -->
  <div id="fieldPanel" class="field-panel hidden">
    <div class="header">
      <span class="brand">HOSCAD FIELD</span>
      <span class="callsign-label" id="callsignLabel"></span>
      <span class="cad-unit-status cad-status-AV" id="cadUnitStatus">AV</span>
      <span class="offline-indicator" id="offlineIndicator">OFFLINE</span>
      <button class="btn-night" id="btnNight" title="TOGGLE NIGHT MODE">NIGHT</button>
      <button class="btn-refresh" id="btnRefresh" title="FORCE REFRESH">REFRESH</button>
      <button class="btn-logout" id="btnLogout">LOGOUT</button>
    </div>

    <!-- Alert/Note Banners -->
    <div id="alertBanner" class="field-banner alert"></div>
    <div id="noteBanner" class="field-banner note"></div>

    <!-- Active Call Card -->
    <div id="callCard" class="call-card">
      <div class="call-card-header">
        <span class="call-card-inc" id="callCardInc">--</span>
        <span class="call-card-nature" id="callCardNature"></span>
      </div>
      <div class="call-card-address" id="callCardAddress">--</div>
      <div class="call-card-detail">
        <div id="callCardCity"></div>
        <div id="callCardCross"></div>
        <div id="callCardCallback"></div>
      </div>
      <div class="call-card-note" id="callCardNote"></div>
      <div class="call-card-units" id="callCardUnits"></div>
    </div>

    <!-- Status Update Buttons -->
    <div class="field-status-buttons">
      <button class="field-status-btn field-status-de" data-status="DE">ENRTE</button>
      <button class="field-status-btn field-status-os" data-status="OS">ON SC</button>
      <button class="field-status-btn field-status-t" data-status="T">TRANS</button>
      <button class="field-status-btn field-status-av" data-status="AV">AVAIL</button>
      <button class="field-status-btn field-status-oos" data-status="OOS">OOS</button>
      <button class="field-status-btn field-status-brk" data-status="BRK">BRK</button>
    </div>

    <!-- Command Bar Area -->
    <div class="cmd-area">
      <div class="cmd-feed" id="cmdFeed">
        <div class="cmd-feed-line"><span class="cmd-sys">HOSCAD FIELD READY. TYPE HELP FOR COMMANDS.</span></div>
      </div>
      <div class="cmd-input-row">
        <input id="cmdInput" placeholder="COMMAND..." maxlength="300" autocomplete="off" />
        <button id="btnCmdSend">SEND</button>
      </div>
      <div class="cmd-quick-row">
        <button class="cmd-quick-btn" data-cmd="10-4">10-4</button>
        <button class="cmd-quick-btn" data-cmd="WHO">WHO</button>
        <button class="cmd-quick-btn" data-cmd="STATUS">STATUS</button>
        <button class="cmd-quick-btn" data-cmd="MSG STA_; ">MSG STA</button>
        <button class="cmd-quick-btn" data-cmd="REFRESH">REFRESH</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Dialog -->
<div id="confirmOverlay" class="confirm-overlay">
  <div class="confirm-box">
    <div class="confirm-title" id="confirmTitle">CONFIRM</div>
    <div class="confirm-message" id="confirmMessage"></div>
    <div class="confirm-buttons">
      <button class="btn-confirm-yes" id="confirmYes">YES</button>
      <button class="btn-confirm-no" id="confirmNo">CANCEL</button>
    </div>
  </div>
</div>

<script src="api.js"></script>

<script>
(function() {
  const loginScreen = document.getElementById('loginScreen');
  const fieldPanel = document.getElementById('fieldPanel');
  const loginErr = document.getElementById('loginErr');
  const callsignLabel = document.getElementById('callsignLabel');
  const cadUnitStatus = document.getElementById('cadUnitStatus');
  const cmdFeed = document.getElementById('cmdFeed');
  const cmdInput = document.getElementById('cmdInput');
  const offlineIndicator = document.getElementById('offlineIndicator');

  // ── Audio ──
  function _alertTone() {
    try { new Audio('tone-urgent.wav').play().catch(function(){}); } catch(e) {}
  }
  // Unlock audio on first user gesture (mobile)
  let _audioUnlocked = false;
  ['touchstart','mousedown','keydown'].forEach(function(evt) {
    document.addEventListener(evt, function() {
      if (_audioUnlocked) return;
      try {
        const a = new Audio();
        a.src = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA=';
        a.volume = 0;
        a.play().then(function() { a.pause(); }).catch(function(){});
        _audioUnlocked = true;
      } catch(e) {}
    }, { passive: true });
  });

  let _cadToken = null;
  let _cadCallsign = '';
  let _cadUnitInfo = '';
  let _pollTimer = null;
  let _knownMsgIds = new Set();
  let _currentStatus = 'AV';
  let _currentIncident = '';
  let _previousStatus = '';
  let _previousIncident = '';
  let _addrCache = {};   // addr_id -> address object
  let _addrList = [];    // flat array for search
  let _lastState = null; // last polled state for WHO/STATUS
  let _isOnline = true;
  let _offlineQueue = [];
  let _nightOverride = null; // null = auto, true = forced on, false = forced off

  const STATUS_LABELS = {
    D: 'PENDING', DE: 'ENROUTE', OS: 'ON SCENE', T: 'TRANSPORT',
    AV: 'AVAILABLE', UV: 'UNAVAILABLE', BRK: 'BREAK', OOS: 'OUT OF SERVICE',
    F: 'FUELING', FD: 'FUELING/DEST'
  };

  // ── Helpers ──
  function esc(s) {
    return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  function fmtTime(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    if (isNaN(d)) return '';
    return String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
  }

  function nowTS() {
    const d = new Date();
    return String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0') + ':' + String(d.getSeconds()).padStart(2,'0');
  }

  function elapsedStr(isoDate) {
    if (!isoDate) return '';
    const diff = Math.floor((Date.now() - new Date(isoDate).getTime()) / 60000);
    if (diff < 1) return '<1M';
    if (diff < 60) return diff + 'M';
    return Math.floor(diff/60) + 'H' + (diff%60) + 'M';
  }

  function feedAppend(html) {
    const div = document.createElement('div');
    div.className = 'cmd-feed-line';
    div.innerHTML = html;
    cmdFeed.appendChild(div);
    cmdFeed.scrollTop = cmdFeed.scrollHeight;
  }

  function feedSys(text) { feedAppend('<span class="cmd-sys">' + esc(text) + '</span>'); }
  function feedErr(text) { feedAppend('<span class="cmd-err">' + esc(text) + '</span>'); }

  // ── Address Cache ──
  async function loadAddresses() {
    try {
      if (!_cadToken) return;
      const res = await API.getAddresses(_cadToken);
      if (res.ok && res.addresses) {
        _addrCache = {};
        _addrList = res.addresses;
        res.addresses.forEach(function(a) { _addrCache[a.id] = a; });
      }
    } catch(e) { console.warn('[field] Address load failed:', e); }
  }

  function resolveAddr(dest) {
    if (!dest) return '--';
    const a = _addrCache[dest.toUpperCase ? dest.toUpperCase() : dest];
    return a ? a.name : dest;
  }

  // ── Offline Queue ──
  function loadOfflineQueue() {
    try {
      const q = localStorage.getItem('hoscadfield_queue');
      if (q) _offlineQueue = JSON.parse(q);
    } catch(e) { _offlineQueue = []; }
  }

  function saveOfflineQueue() {
    try { localStorage.setItem('hoscadfield_queue', JSON.stringify(_offlineQueue)); } catch(e) {}
  }

  function queueStatusUpdate(statusCode, note) {
    _offlineQueue.push({ type: 'status', status: statusCode, note: note || '', ts: Date.now() });
    saveOfflineQueue();
  }

  async function flushOfflineQueue() {
    if (!_offlineQueue.length || !_cadToken || !_cadCallsign) return;
    const queue = _offlineQueue.slice();
    _offlineQueue = [];
    saveOfflineQueue();
    for (const item of queue) {
      try {
        if (item.type === 'status') {
          const patch = { status: item.status };
          if (item.note) patch.note = item.note;
          await API.upsertUnit(_cadToken, _cadCallsign, patch);
          feedSys('QUEUED STATUS ' + item.status + ' SENT');
        }
      } catch(e) {
        // Re-queue on failure
        _offlineQueue.push(item);
        saveOfflineQueue();
        break;
      }
    }
  }

  function setOnline(online) {
    _isOnline = online;
    offlineIndicator.style.display = online ? 'none' : 'inline-block';
    if (online && _offlineQueue.length) {
      flushOfflineQueue();
    }
  }

  // ── LocalStorage Call Cache ──
  function cacheCallInfo(data) {
    try { localStorage.setItem('hoscadfield_callcache', JSON.stringify(data)); } catch(e) {}
  }

  function loadCachedCallInfo() {
    try {
      const c = localStorage.getItem('hoscadfield_callcache');
      return c ? JSON.parse(c) : null;
    } catch(e) { return null; }
  }

  // ── Status Badge ──
  function updateStatusBadge(code) {
    _previousStatus = _currentStatus;
    _currentStatus = code;
    cadUnitStatus.textContent = code;
    cadUnitStatus.className = 'cad-unit-status cad-status-' + code;
    document.querySelectorAll('.field-status-btn').forEach(function(btn) {
      btn.classList.toggle('current', btn.dataset.status === code);
    });
  }

  // ── Active Call Card ──
  function updateCallCard(unit, state) {
    const el = document.getElementById('callCard');
    if (!el) return;

    if (unit && unit.incident) {
      _previousIncident = _currentIncident;
      _currentIncident = unit.incident;

      // Find incident details from state
      const inc = (state && state.incidents || []).find(function(i) {
        return i.incident_id === unit.incident;
      });

      document.getElementById('callCardInc').textContent = 'INC ' + unit.incident;

      if (inc) {
        document.getElementById('callCardNature').textContent = inc.incident_type || '';
        const destAddr = resolveAddr(inc.destination || unit.destination);
        document.getElementById('callCardAddress').textContent = destAddr;

        // Try to show more address detail from addr cache
        const addrKey = (inc.destination || unit.destination || '').toUpperCase();
        const addrObj = _addrCache[addrKey];
        if (addrObj) {
          document.getElementById('callCardCity').textContent = (addrObj.city || '') + ' ' + (addrObj.state || '') + ' ' + (addrObj.zip || '');
          document.getElementById('callCardCross').textContent = addrObj.cross ? 'X: ' + addrObj.cross : '';
          document.getElementById('callCardCallback').textContent = addrObj.phone ? 'PH: ' + addrObj.phone : '';
        } else {
          document.getElementById('callCardCity').textContent = '';
          document.getElementById('callCardCross').textContent = '';
          document.getElementById('callCardCallback').textContent = '';
        }

        document.getElementById('callCardNote').textContent = inc.incident_note ? 'NOTE: ' + inc.incident_note : '';
        document.getElementById('callCardUnits').textContent = inc.units ? 'UNITS: ' + inc.units : '';

        // Cache for offline
        cacheCallInfo({
          incident: unit.incident,
          nature: inc.incident_type || '',
          address: destAddr,
          note: inc.incident_note || '',
          units: inc.units || '',
          ts: Date.now()
        });
      } else {
        document.getElementById('callCardNature').textContent = '';
        document.getElementById('callCardAddress').textContent = resolveAddr(unit.destination);
        document.getElementById('callCardCity').textContent = '';
        document.getElementById('callCardCross').textContent = '';
        document.getElementById('callCardCallback').textContent = '';
        document.getElementById('callCardNote').textContent = unit.note ? 'NOTE: ' + unit.note : '';
        document.getElementById('callCardUnits').textContent = '';
      }

      el.style.display = '';
    } else {
      el.style.display = 'none';
      _currentIncident = '';
    }
  }

  // ── Banners ──
  function updateBanners(state) {
    const alertEl = document.getElementById('alertBanner');
    const noteEl = document.getElementById('noteBanner');

    if (state.alert_banner) {
      alertEl.textContent = state.alert_banner;
      alertEl.style.display = 'block';
    } else {
      alertEl.style.display = 'none';
    }

    if (state.note_banner) {
      noteEl.textContent = state.note_banner;
      noteEl.style.display = 'block';
    } else {
      noteEl.style.display = 'none';
    }
  }

  // ── Night Mode ──
  function checkNightMode() {
    if (_nightOverride !== null) {
      document.body.classList.toggle('night-mode', _nightOverride);
      return;
    }
    const h = new Date().getHours();
    const isNight = (h >= 18 || h < 6);
    document.body.classList.toggle('night-mode', isNight);
  }

  function toggleNightMode() {
    const isOn = document.body.classList.contains('night-mode');
    _nightOverride = !isOn;
    document.body.classList.toggle('night-mode', !isOn);
    try { localStorage.setItem('hoscadfield_nightoverride', String(_nightOverride)); } catch(e) {}
  }

  function loadNightOverride() {
    try {
      const v = localStorage.getItem('hoscadfield_nightoverride');
      if (v === 'true') _nightOverride = true;
      else if (v === 'false') _nightOverride = false;
      else _nightOverride = null;
    } catch(e) { _nightOverride = null; }
  }

  // ── Show/Hide ──
  function showField(callsign) {
    loginScreen.style.display = 'none';
    fieldPanel.classList.remove('hidden');
    callsignLabel.textContent = callsign;
  }

  function showLogin() {
    loginScreen.style.display = 'flex';
    fieldPanel.classList.add('hidden');
    callsignLabel.textContent = '';
    cadUnitStatus.textContent = '--';
    cadUnitStatus.className = 'cad-unit-status';
    cmdFeed.innerHTML = '<div class="cmd-feed-line"><span class="cmd-sys">HOSCAD FIELD READY. TYPE HELP FOR COMMANDS.</span></div>';
    document.getElementById('callCard').style.display = 'none';
    document.getElementById('alertBanner').style.display = 'none';
    document.getElementById('noteBanner').style.display = 'none';
  }

  // ── Session Persistence ──
  function saveSession() {
    try {
      localStorage.setItem('hoscadfield_token', _cadToken || '');
      localStorage.setItem('hoscadfield_callsign', _cadCallsign || '');
      localStorage.setItem('hoscadfield_unitinfo', _cadUnitInfo || '');
    } catch(e) {}
  }

  function loadSession() {
    try {
      _cadToken = localStorage.getItem('hoscadfield_token') || '';
      _cadCallsign = localStorage.getItem('hoscadfield_callsign') || '';
      _cadUnitInfo = localStorage.getItem('hoscadfield_unitinfo') || '';
    } catch(e) {}
  }

  function clearSession() {
    try {
      localStorage.removeItem('hoscadfield_token');
      localStorage.removeItem('hoscadfield_callsign');
      localStorage.removeItem('hoscadfield_unitinfo');
      localStorage.removeItem('hoscadfield_callcache');
      localStorage.removeItem('hoscadfield_queue');
    } catch(e) {}
    _cadToken = null;
    _cadCallsign = '';
    _cadUnitInfo = '';
  }

  // ── CAD Login ──
  async function cadLogin(callsign, unitInfo) {
    const res = await API.login('UNIT', callsign, '');
    if (!res.ok) {
      return res.error || 'CAD LOGIN FAILED';
    }
    _cadToken = res.token;
    _cadCallsign = callsign.toUpperCase();
    _cadUnitInfo = unitInfo;
    saveSession();

    // Register on dispatch board
    const upsert = await API.upsertUnit(_cadToken, _cadCallsign, {
      active: true,
      status: 'AV',
      unitInfo: _cadUnitInfo
    });
    if (!upsert.ok) {
      console.warn('[field] Unit upsert failed:', upsert.error);
    }

    updateStatusBadge('AV');
    loadAddresses();

    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }

    // Night mode check
    loadNightOverride();
    checkNightMode();

    startPolling();
    return null;
  }

  // ── CAD Logout ──
  async function cadLogout() {
    stopPolling();
    if (_cadToken && _cadCallsign) {
      try {
        await API.upsertUnit(_cadToken, _cadCallsign, { active: false });
      } catch(e) {}
      try {
        await API.logout(_cadToken);
      } catch(e) {}
    }
    clearSession();
  }

  // ── Polling ──
  function startPolling() {
    stopPolling();
    pollOnce();
    _pollTimer = setInterval(pollOnce, 5000);
  }

  function stopPolling() {
    if (_pollTimer) { clearInterval(_pollTimer); _pollTimer = null; }
  }

  async function pollOnce() {
    if (!_cadToken) return;
    try {
      const state = await API.getState(_cadToken);
      if (!state.ok) {
        if (state.error && state.error.includes('NETWORK ERROR')) {
          setOnline(false);
        }
        if (state.error && state.error.includes('TOKEN EXPIRED')) {
          feedErr('SESSION EXPIRED. PLEASE LOG OUT AND RECONNECT.');
          stopPolling();
        }
        return;
      }

      setOnline(true);
      _lastState = state;

      // Update banners
      updateBanners(state);

      // Find own unit
      const myUnit = (state.units || []).find(function(u) {
        return u.unit_id.toUpperCase() === _cadCallsign.toUpperCase();
      });

      if (myUnit) {
        const prevStatus = _currentStatus;
        const prevIncident = _currentIncident;

        updateStatusBadge(myUnit.status || 'AV');
        updateCallCard(myUnit, state);

        // Detect status change by dispatch
        if (prevStatus && prevStatus !== _currentStatus && prevStatus !== 'AV') {
          const label = STATUS_LABELS[_currentStatus] || _currentStatus;
          feedAppend('<span class="cmd-status-change">[' + nowTS() + '] STATUS CHANGED TO ' + label + ' BY DISPATCH</span>');
          _alertTone();
          // Browser notification
          if ('Notification' in window && Notification.permission === 'granted' &&
              (document.hidden || !document.hasFocus())) {
            try {
              new Notification('STATUS: ' + label, {
                body: _cadCallsign + ' status changed to ' + label,
                tag: 'cad-status-' + Date.now(),
                requireInteraction: false
              });
            } catch(e) {}
          }
        }

        // Detect new incident assignment
        if (_currentIncident && prevIncident !== _currentIncident) {
          feedAppend('<span class="cmd-status-change">[' + nowTS() + '] ASSIGNED TO INC ' + _currentIncident + '</span>');
          _alertTone();
          if ('Notification' in window && Notification.permission === 'granted' &&
              (document.hidden || !document.hasFocus())) {
            try {
              new Notification('NEW CALL: INC ' + _currentIncident, {
                body: 'You have been assigned to incident ' + _currentIncident,
                tag: 'cad-inc-' + _currentIncident,
                requireInteraction: true
              });
            } catch(e) {}
          }
        }
      }

      // Process messages
      const msgs = state.messages || [];
      for (let i = msgs.length - 1; i >= 0; i--) {
        const m = msgs[i];
        if (_knownMsgIds.has(m.message_id)) continue;
        _knownMsgIds.add(m.message_id);

        const ts = fmtTime(m.ts);
        const urgentTag = m.urgent ? '<span class="cmd-urgent">[URGENT] </span>' : '';
        feedAppend(
          '<span class="cmd-ts">' + esc(ts) + '</span> ' +
          urgentTag +
          '<span class="cmd-from">[' + esc(m.from_role) + ']</span> ' +
          esc(m.message)
        );

        if (m.urgent && !m.read) {
          _alertTone();
        }

        if (!m.read && 'Notification' in window && Notification.permission === 'granted' &&
            (document.hidden || !document.hasFocus())) {
          try {
            const title = m.urgent ? 'URGENT MSG from ' + m.from_role : 'MSG from ' + m.from_role;
            new Notification(title, {
              body: m.message,
              tag: 'cad-msg-' + m.message_id,
              requireInteraction: !!m.urgent
            });
          } catch(e) {}
        }

        if (!m.read) {
          API.readMessage(_cadToken, m.message_id).catch(function(){});
        }
      }

    } catch(e) {
      console.error('[field] Poll error:', e);
      setOnline(false);
    }
  }

  // ── Confirm Dialog ──
  let _confirmResolve = null;

  function showConfirm(title, message) {
    return new Promise(function(resolve) {
      _confirmResolve = resolve;
      document.getElementById('confirmTitle').textContent = title;
      document.getElementById('confirmMessage').textContent = message;
      document.getElementById('confirmOverlay').classList.add('active');
    });
  }

  document.getElementById('confirmYes').addEventListener('click', function() {
    document.getElementById('confirmOverlay').classList.remove('active');
    if (_confirmResolve) { _confirmResolve(true); _confirmResolve = null; }
  });

  document.getElementById('confirmNo').addEventListener('click', function() {
    document.getElementById('confirmOverlay').classList.remove('active');
    if (_confirmResolve) { _confirmResolve(false); _confirmResolve = null; }
  });

  // ── Status Update ──
  async function updateFieldStatus(statusCode, note) {
    if (!_cadToken || !_cadCallsign) return;

    // Confirm OOS
    if (statusCode === 'OOS') {
      const ok = await showConfirm('OUT OF SERVICE', 'SET STATUS TO OUT OF SERVICE?\nTHIS WILL REMOVE YOU FROM AVAILABLE UNITS.');
      if (!ok) return;
    }

    const patch = { status: statusCode };
    if (note) patch.note = note;

    try {
      const res = await API.upsertUnit(_cadToken, _cadCallsign, patch);
      if (res.ok) {
        updateStatusBadge(statusCode);
        const label = STATUS_LABELS[statusCode] || statusCode;
        feedSys('[' + nowTS() + '] STATUS -> ' + label + (note ? ' (' + note + ')' : ''));
      } else {
        feedErr('STATUS UPDATE FAILED: ' + (res.error || 'UNKNOWN'));
      }
    } catch(e) {
      // Offline — queue it
      setOnline(false);
      queueStatusUpdate(statusCode, note);
      updateStatusBadge(statusCode);
      feedSys('[' + nowTS() + '] STATUS -> ' + statusCode + ' (QUEUED - OFFLINE)');
    }
  }

  // ── Command Processing ──
  function processCommand(raw) {
    const text = raw.trim().toUpperCase();
    if (!text) return;

    // Status commands: DE, OS, T, AV, OOS, BRK, UV
    const statusMatch = text.match(/^(DE|OS|T|AV|OOS|BRK|UV)(?:\s*;\s*(.*))?$/);
    if (statusMatch) {
      updateFieldStatus(statusMatch[1], statusMatch[2] || '');
      return;
    }

    // MSG <target>; <text>
    const msgMatch = text.match(/^MSG\s+(\S+)\s*;\s*(.+)$/);
    if (msgMatch) {
      const target = msgMatch[1];
      const body = msgMatch[2];
      API.sendMessage(_cadToken, target, body, false).then(function(res) {
        if (res.ok) {
          feedSys('MSG SENT TO ' + target + ': ' + body);
        } else {
          feedErr('MSG FAILED: ' + (res.error || 'UNKNOWN'));
        }
      });
      return;
    }

    // HTMSG <target>; <text>
    const htmsgMatch = text.match(/^HTMSG\s+(\S+)\s*;\s*(.+)$/);
    if (htmsgMatch) {
      const target = htmsgMatch[1];
      const body = htmsgMatch[2];
      API.sendMessage(_cadToken, target, body, true).then(function(res) {
        if (res.ok) {
          feedSys('URGENT MSG SENT TO ' + target + ': ' + body);
        } else {
          feedErr('HTMSG FAILED: ' + (res.error || 'UNKNOWN'));
        }
      });
      return;
    }

    // NOTE; <text>
    const noteMatch = text.match(/^NOTE\s*;\s*(.+)$/);
    if (noteMatch) {
      if (!_currentIncident) {
        feedErr('NO ACTIVE INCIDENT. NOTE NOT ADDED.');
        return;
      }
      API.appendIncidentNote(_cadToken, _currentIncident, noteMatch[1]).then(function(res) {
        if (res.ok) {
          feedSys('NOTE ADDED TO INC ' + _currentIncident);
        } else {
          feedErr('NOTE FAILED: ' + (res.error || 'UNKNOWN'));
        }
      });
      return;
    }

    // WHO — all active units
    if (text === 'WHO') {
      if (!_lastState || !_lastState.units) {
        feedErr('NO DATA. TRY REFRESH FIRST.');
        return;
      }
      const units = _lastState.units.filter(function(u) { return u.active; });
      feedSys('--- ACTIVE UNITS (' + units.length + ') ---');
      units.forEach(function(u) {
        const st = (u.status || '--').padEnd(4);
        const label = (STATUS_LABELS[u.status] || u.status || '--').padEnd(14);
        const inc = u.incident ? 'INC' + u.incident : '';
        const dest = u.destination ? resolveAddr(u.destination) : '';
        feedSys(u.unit_id.padEnd(9) + st + ' ' + label + ' ' + inc + '  ' + dest);
      });
      return;
    }

    // STATUS — own status
    if (text === 'STATUS') {
      const label = STATUS_LABELS[_currentStatus] || _currentStatus;
      feedSys('--- YOUR STATUS ---');
      feedSys('UNIT: ' + _cadCallsign + ' | STATUS: ' + _currentStatus + ' (' + label + ')');
      if (_currentIncident) {
        feedSys('INCIDENT: INC ' + _currentIncident);
        // Find destination from state
        if (_lastState && _lastState.units) {
          const u = _lastState.units.find(function(u) { return u.unit_id.toUpperCase() === _cadCallsign.toUpperCase(); });
          if (u) {
            feedSys('DEST: ' + resolveAddr(u.destination) + (u.note ? ' | NOTE: ' + u.note : ''));
            if (u.updated_at) feedSys('STATUS TIME: ' + fmtTime(u.updated_at) + ' (' + elapsedStr(u.updated_at) + ')');
          }
        }
      } else {
        feedSys('NO ACTIVE INCIDENT');
        if (_lastState && _lastState.units) {
          const u = _lastState.units.find(function(u) { return u.unit_id.toUpperCase() === _cadCallsign.toUpperCase(); });
          if (u && u.updated_at) feedSys('STATUS TIME: ' + fmtTime(u.updated_at) + ' (' + elapsedStr(u.updated_at) + ')');
        }
      }
      return;
    }

    // ADDR / ADDR <search>
    const addrMatch = text.match(/^ADDR(?:\s+(.+))?$/);
    if (addrMatch) {
      const query = addrMatch[1] || '';
      if (!query) {
        feedSys('USAGE: ADDR <SEARCH TERM>');
        feedSys('EXAMPLE: ADDR MERCY');
        return;
      }
      const results = _addrList.filter(function(a) {
        const hay = ((a.name || '') + ' ' + (a.id || '') + ' ' + (a.address || '')).toUpperCase();
        return hay.includes(query);
      });
      if (results.length === 0) {
        feedErr('NO ADDRESSES FOUND FOR: ' + query);
      } else {
        feedSys('--- ADDRESS RESULTS (' + Math.min(results.length, 10) + '/' + results.length + ') ---');
        results.slice(0, 10).forEach(function(a) {
          feedSys(a.name || a.id);
          if (a.address) feedSys('  ' + a.address + (a.city ? ', ' + a.city : '') + (a.state ? ' ' + a.state : '') + (a.zip ? ' ' + a.zip : ''));
          if (a.phone) feedSys('  PH: ' + a.phone);
          if (a.cross) feedSys('  X: ' + a.cross);
        });
      }
      return;
    }

    // REFRESH
    if (text === 'REFRESH') {
      feedSys('REFRESHING...');
      pollOnce().then(function() { feedSys('REFRESH COMPLETE.'); });
      return;
    }

    // CLOSE <inc>
    const closeMatch = text.match(/^CLOSE\s+(.+)$/);
    if (closeMatch) {
      API.closeIncident(_cadToken, closeMatch[1]).then(function(res) {
        if (res.ok) {
          feedSys('INCIDENT ' + closeMatch[1] + ' CLOSED.');
        } else {
          feedErr('CLOSE FAILED: ' + (res.error || 'UNKNOWN'));
        }
      });
      return;
    }

    // R <inc> — review incident
    const reviewMatch = text.match(/^R\s+(.+)$/);
    if (reviewMatch) {
      API.getIncident(_cadToken, reviewMatch[1]).then(function(res) {
        if (res.ok && res.incident) {
          const i = res.incident;
          feedSys('--- INCIDENT ' + i.incident_id + ' ---');
          feedSys('STATUS: ' + i.status + ' | DEST: ' + resolveAddr(i.destination));
          feedSys('TYPE: ' + (i.incident_type || '--') + ' | UNITS: ' + (i.units || '--'));
          if (i.incident_note) feedSys('NOTE: ' + i.incident_note);
          if (res.audit && res.audit.length > 0) {
            feedSys('RECENT ACTIVITY:');
            res.audit.slice(-5).forEach(function(a) {
              feedSys('  ' + fmtTime(a.ts) + ' ' + a.message + ' [' + a.actor + ']');
            });
          }
        } else {
          feedErr('REVIEW FAILED: ' + (res.error || 'UNKNOWN'));
        }
      });
      return;
    }

    // LO / LOGOUT
    if (text === 'LO' || text === 'LOGOUT') {
      (async function() {
        const ok = await showConfirm('LOGOUT', 'LOG OUT OF HOSCAD FIELD?\nYOUR UNIT WILL BE REMOVED FROM THE BOARD.');
        if (!ok) return;
        feedSys('LOGGING OUT...');
        try { await cadLogout(); } catch(e) { console.error('[field] cadLogout error:', e); }
        showLogin();
      })();
      return;
    }

    // CLS - clear screen
    if (text === 'CLS' || text === 'CLEAR') {
      cmdFeed.innerHTML = '<div class="cmd-feed-line"><span class="cmd-sys">SCREEN CLEARED.</span></div>';
      return;
    }

    // HELP
    if (text === 'HELP') {
      feedSys('--- HOSCAD FIELD COMMAND REFERENCE ---');
      feedSys('DE / OS / T / AV        STATUS UPDATE (INSTANT)');
      feedSys('OOS / BRK / UV          STATUS UPDATE (OOS = CONFIRM)');
      feedSys('  STATUS; NOTE           STATUS WITH NOTE');
      feedSys('MSG <TARGET>; <TEXT>     SEND MESSAGE');
      feedSys('HTMSG <TARGET>; <TEXT>   SEND URGENT MESSAGE');
      feedSys('WHO                     ALL ACTIVE UNITS + STATUS');
      feedSys('STATUS                  YOUR STATUS DETAILS');
      feedSys('NOTE; <TEXT>            ADD NOTE TO ACTIVE INCIDENT');
      feedSys('ADDR <SEARCH>           FACILITY ADDRESS LOOKUP');
      feedSys('R <INC>                 REVIEW INCIDENT');
      feedSys('CLOSE <INC>             CLOSE INCIDENT');
      feedSys('REFRESH                 FORCE POLL');
      feedSys('LO                      LOG OUT (CONFIRM)');
      feedSys('CLS                     CLEAR SCREEN');
      feedSys('HELP                    THIS REFERENCE');
      feedSys('TARGET = ROLE (STA1) OR UNIT (EMS12)');
      return;
    }

    // 10-4
    if (text === '10-4') {
      feedSys('10-4.');
      return;
    }

    feedErr('UNKNOWN COMMAND. TYPE HELP FOR REFERENCE.');
  }

  // ── Event Bindings ──

  // Login
  document.getElementById('btnLogin').addEventListener('click', async function() {
    const cs = document.getElementById('loginCallsign').value.trim();
    const info = document.getElementById('loginUnitInfo').value.trim();
    loginErr.textContent = '';

    if (!cs) { loginErr.textContent = 'ENTER A CALLSIGN.'; return; }
    if (cs.length < 2) { loginErr.textContent = 'CALLSIGN TOO SHORT.'; return; }

    loginErr.textContent = 'CONNECTING...';

    const cadErr = await cadLogin(cs, info);
    if (cadErr) {
      loginErr.textContent = 'CAD: ' + cadErr;
      return;
    }

    showField(cs.toUpperCase());
    feedSys('LOGGED IN AS ' + cs.toUpperCase() + '. HOSCAD FIELD ACTIVE.');
  });

  // Enter key on login fields
  document.getElementById('loginCallsign').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') document.getElementById('btnLogin').click();
  });
  document.getElementById('loginUnitInfo').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') document.getElementById('btnLogin').click();
  });

  // Logout button
  document.getElementById('btnLogout').addEventListener('click', async function() {
    const ok = await showConfirm('LOGOUT', 'LOG OUT OF HOSCAD FIELD?\nYOUR UNIT WILL BE REMOVED FROM THE BOARD.');
    if (!ok) return;
    feedSys('LOGGING OUT...');
    try { await cadLogout(); } catch(e) { console.error('[field] cadLogout error:', e); }
    showLogin();
  });

  // Refresh button
  document.getElementById('btnRefresh').addEventListener('click', function() {
    feedSys('REFRESHING...');
    pollOnce().then(function() { feedSys('REFRESH COMPLETE.'); });
  });

  // Night mode button
  document.getElementById('btnNight').addEventListener('click', toggleNightMode);

  // Command bar
  document.getElementById('btnCmdSend').addEventListener('click', function() {
    const text = cmdInput.value.trim();
    if (!text) return;
    processCommand(text);
    cmdInput.value = '';
  });

  cmdInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') document.getElementById('btnCmdSend').click();
  });

  // Quick action buttons
  document.querySelectorAll('.cmd-quick-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const cmd = btn.dataset.cmd;
      if (cmd === '10-4' || cmd === 'WHO' || cmd === 'STATUS' || cmd === 'REFRESH') {
        processCommand(cmd);
      } else {
        cmdInput.value = cmd;
        cmdInput.focus();
      }
    });
  });

  // Status buttons
  document.querySelectorAll('.field-status-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const status = btn.dataset.status;
      if (status) updateFieldStatus(status);
    });
  });

  // Online/offline listeners
  window.addEventListener('online', function() { setOnline(true); });
  window.addEventListener('offline', function() { setOnline(false); });

  // ── PWA Install Prompt ──
  let _deferredInstallPrompt = null;
  const btnInstall = document.getElementById('btnInstall');

  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

  window.addEventListener('beforeinstallprompt', function(e) {
    e.preventDefault();
    _deferredInstallPrompt = e;
    btnInstall.textContent = 'INSTALL APP';
    btnInstall.style.display = 'block';
  });

  if (isIOS && !isStandalone) {
    btnInstall.textContent = 'INSTALL: TAP SHARE \u2197 THEN "ADD TO HOME SCREEN"';
    btnInstall.style.display = 'block';
  }

  btnInstall.addEventListener('click', async function() {
    if (_deferredInstallPrompt) {
      _deferredInstallPrompt.prompt();
      const result = await _deferredInstallPrompt.userChoice;
      if (result.outcome === 'accepted') {
        btnInstall.style.display = 'none';
      }
      _deferredInstallPrompt = null;
    } else if (isIOS) {
      alert('To install HOSCAD Field:\n\n1. Tap the Share button (box with up arrow) at the bottom of Safari\n2. Scroll down and tap "Add to Home Screen"\n3. Tap "Add"\n\nThe app will appear on your home screen.');
    }
  });

  window.addEventListener('appinstalled', function() {
    btnInstall.style.display = 'none';
    _deferredInstallPrompt = null;
  });

  // ── Auto Night Mode Check (hourly) ──
  setInterval(function() {
    if (_nightOverride === null) checkNightMode();
  }, 3600000);

  // ── Auto-reconnect on page load ──
  window.addEventListener('load', async function() {
    // Service worker
    if ('serviceWorker' in navigator && !window.desktopAPI) {
      navigator.serviceWorker.register('./sw-field.js', { updateViaCache: 'none' })
        .then(function(reg) {
          setInterval(function() { reg.update(); }, 5 * 60 * 1000);
          reg.addEventListener('updatefound', function() {
            var newSW = reg.installing;
            if (newSW) {
              newSW.addEventListener('statechange', function() {
                if (newSW.state === 'activated' && navigator.serviceWorker.controller) {
                  window.location.reload();
                }
              });
            }
          });
        })
        .catch(function() {});
    }

    // Night mode
    loadNightOverride();
    checkNightMode();

    // Load offline queue
    loadOfflineQueue();

    // Try reconnect
    loadSession();
    if (_cadToken && _cadCallsign) {
      showField(_cadCallsign);
      feedSys('RECONNECTING AS ' + _cadCallsign + '...');

      // Try polling to see if session is still valid
      try {
        const state = await API.getState(_cadToken);
        if (state.ok) {
          _lastState = state;
          updateBanners(state);
          const myUnit = (state.units || []).find(function(u) {
            return u.unit_id.toUpperCase() === _cadCallsign.toUpperCase();
          });
          if (myUnit) {
            updateStatusBadge(myUnit.status || 'AV');
            updateCallCard(myUnit, state);
          }
          startPolling();
          loadAddresses();
          setOnline(true);
          flushOfflineQueue();
          feedSys('RECONNECTED AS ' + _cadCallsign + '. HOSCAD FIELD ACTIVE.');
        } else {
          // Token expired — re-login
          feedSys('SESSION EXPIRED. RE-AUTHENTICATING...');
          const cadErr = await cadLogin(_cadCallsign, _cadUnitInfo);
          if (cadErr) {
            feedErr('RECONNECT FAILED: ' + cadErr);
            showLogin();
          } else {
            feedSys('RECONNECTED AS ' + _cadCallsign + '. HOSCAD FIELD ACTIVE.');
          }
        }
      } catch(e) {
        // Offline — show cached data
        setOnline(false);
        const cached = loadCachedCallInfo();
        if (cached) {
          document.getElementById('callCard').style.display = '';
          document.getElementById('callCardInc').textContent = 'INC ' + (cached.incident || '--');
          document.getElementById('callCardNature').textContent = cached.nature || '';
          document.getElementById('callCardAddress').textContent = cached.address || '--';
          document.getElementById('callCardNote').textContent = cached.note ? 'NOTE: ' + cached.note : '';
          document.getElementById('callCardUnits').textContent = cached.units ? 'UNITS: ' + cached.units : '';
          feedSys('OFFLINE — SHOWING CACHED CALL INFO');
        }
        startPolling();
        feedErr('OFFLINE. WILL RETRY AUTOMATICALLY.');
      }
    }
  });
})();
</script>
</body>
</html>
